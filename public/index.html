<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ChatWidget</title>
<style>
  body {
    margin: 0;
    padding: 20px;
    font: 1em/1.5 "Inter", sans-serif;
    background: transparent;
    display: flex;
    justify-content: center;
    align-items: center;
    height: calc(100vh - 40px);
    color: #262623;
    box-sizing: border-box;
  }

  .chat {
    width: 620px;
    height: 520px;
    max-width: 100%;
    background: #ffffff;
    display: flex;
    flex-direction: column;
    overflow: hidden;
    position: relative;
  }

  .msgs {
    flex: 1;
    overflow-y: auto;
    display: flex;
    flex-direction: column;
    gap: 1.2rem;
    padding: 1.2rem 1rem;
    margin-bottom: 90px;
    position: relative;
  }

  .intro-text {
    position: absolute;
    top: 50%;
    left: 50%;
    transform: translate(-50%, -50%);
    font-size: 24px;
    color: #E2E2E6;
    text-align: center;
    opacity: 1;
    pointer-events: none;
    transition: opacity 0.3s ease;
    font-weight: 400;
    line-height: 1.4;
  }

  .hide-intro .intro-text {
    opacity: 0;
  }

  .bubble {
    display: inline-block;
    padding: .6rem 1rem;
    border-radius: 18px;
    white-space: pre-line;
    max-width: 80%;
    word-break: break-word;
    font-size: 1em;
  }

  .user {
    background: #214DBF;
    color: #fff;
    border-bottom-right-radius: 0;
    align-self: flex-end;
  }

  .bot {
    background: #F9F7F1;
    color: #262623;
    border-bottom-left-radius: 0;
    align-self: flex-start;
  }

  .composer {
    position: absolute;
    bottom: 0;
    left: 0;
    right: 0;
    display: flex;
    align-items: flex-end;
    padding: 10px 20px 10px 12px;
    background: #ffffff;
    border: 1px solid #F3F3F3;
    border-radius: 25px;
    margin: 10px;
    color: #7F7F84;
    box-shadow: 0 0 20px 10px rgba(0, 0, 0, 0.02);
    box-sizing: border-box;
    min-height: 64px;
  }

  .input-wrapper {
    position: relative;
    flex: 1;
    display: flex;
    flex-direction: column;
  }

  .input-wrapper textarea {
    font-family: inherit;
    font-size: 1em;
    line-height: 1.4;
    padding: 0;
    border: none;
    outline: none;
    resize: none;
    background: #fff;
    color: #7F7F84;
    min-height: 44px;
    max-height: 120px;
    overflow-y: hidden;
    width: 100%;
  }

  .input-wrapper textarea::placeholder {
    color: #7F7F84;
  }

  .input-shadow {
    visibility: hidden;
    white-space: pre-wrap;
    word-wrap: break-word;
    overflow-wrap: break-word;
    font-family: inherit;
    font-size: 1em;
    line-height: 1.4;
    padding: 0;
    position: absolute;
    top: 0;
    left: 0;
    width: 100%;
  }

  .send-btn {
    background: #F9F7F2;
    border: none;
    cursor: pointer;
    margin-left: 0.5rem;
    padding: 0;
    display: flex;
    align-items: center;
    justify-content: center;
    width: 44px;
    height: 44px;
    border-radius: 50%;
    flex-shrink: 0;
  }

  .send-btn img {
    height: 22px;
    width: auto;
    opacity: 0.4;
  }

  @media (max-width: 600px) {
    body {
      padding: 10px;
      height: calc(100vh - 20px);
    }

    .chat {
      width: 100%;
      height: 90vh;
    }
  }
</style>
</head>

<body>
<div class="chat">
  <div id="msgs" class="msgs">
    <div id="introText" class="intro-text">
      Start talking to our product<br>agent Alex below.
    </div>
  </div>

  <form id="composer" class="composer">
    <div class="input-wrapper">
      <textarea id="input" rows="1" placeholder="Type your message…" oninput="handleInputChange()"></textarea>
      <div id="shadow" class="input-shadow"></div>
    </div>
    <button type="submit" class="send-btn">
      <img src="https://cdn-icons-png.flaticon.com/128/608/608336.png" alt="Send">
    </button>
  </form>
</div>

<script>
const webhook = 'https://deepfeed.app.n8n.cloud/webhook/17893bdb-97ae-4ba9-9c97-7ec6f0e644bb';
const sessionId = crypto.randomUUID();
const msgs = document.getElementById('msgs');
const input = document.getElementById('input');
const shadow = document.getElementById('shadow');
const introText = document.getElementById('introText');

document.getElementById('composer').addEventListener('submit', async e => {
  e.preventDefault();
  await sendMessage();
});

input.addEventListener('keydown', async e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    await sendMessage();
  }
});

input.addEventListener('input', () => {
  input.style.color = '#262623';
  syncShadow();
});

function handleInputChange() {
  input.style.color = '#262623';
  if (input.value.trim().length > 0) {
    msgs.classList.add('hide-intro');
  }
  syncShadow();
}

function syncShadow() {
  shadow.textContent = input.value + '\u200B'; // Ensure shadow grows even with empty line
  input.style.height = shadow.offsetHeight + 'px';
}

async function sendMessage() {
  const txt = input.value.trim();
  if (!txt) return;
  add(txt, 'user');
  input.value = '';
  input.style.color = '#7F7F84';
  syncShadow();
  msgs.classList.add('hide-intro');

  const loader = addTypingBubble();

  try {
    const res = await fetch(`${webhook}?action=sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chatInput: txt, sessionId })
    });
    const data = await res.json();
    console.log('n8n responded:', data);

    loader.remove();

    const messages = Array.isArray(data.responses)
      ? data.responses
      : (data.output ? [data.output] : []);

    if (messages.length > 0) {
      messages.forEach(r => add(r, 'bot'));
    } else {
      add('⚠️ No reply received', 'bot');
    }
  } catch (err) {
    console.error(err);
    loader.textContent = '⚠️ error';
  }
}

function add(text, role) {
  const div = document.createElement('div');
  div.className = `bubble ${role === 'user' ? 'user' : 'bot'}`;
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div;
}

function addTypingBubble() {
  const div = document.createElement('div');
  div.className = 'bubble bot';
  div.innerHTML = '<span>...</span>';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div;
}
</script>
</body>
</html>
