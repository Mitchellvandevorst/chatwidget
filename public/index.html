<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ChatWidget</title>

<style>
  /* ------- layout ------- */
  body{
    margin:0;padding:20px;font:1em/1.5 "Inter",sans-serif;
    background:transparent;display:flex;justify-content:center;align-items:center;
    height:calc(100vh - 40px);color:#262623;box-sizing:border-box;
  }
  .chat{
    width:620px;height:520px;max-width:100%;
    background:#fff;display:flex;flex-direction:column;overflow:hidden;
  }

  /* ------- scroll area ------- */
  .msgs{
    flex:1;overflow-y:auto;display:flex;flex-direction:column;
    gap:1.2rem;padding:1.2rem 1rem;
  }

  /* ------- bubbles ------- */
  .bubble{
    display:inline-block;padding:.6rem 1rem;border-radius:18px;
    white-space:pre-line;max-width:80%;word-break:break-word;font-size:1em;
  }
  .user{background:#214DBF;color:#fff;border-bottom-right-radius:0;align-self:flex-end;}
  .bot {background:#F9F7F1;color:#262623;border-bottom-left-radius:0;align-self:flex-start;}

  /* ------- composer ------- */
  .composer{
    display:flex;align-items:center;padding:1.2rem 1rem;
    background:#fff;border-top:1px solid #E8E4E4;
  }
  .composer textarea{
    flex:1;padding:.75rem;border:none;border-radius:12px;resize:none;
    font-family:inherit;font-size:1em;line-height:1.4;color:#262623;
    background:#fff;outline:none;overflow:hidden;
  }
  .send-btn{
    background:none;border:none;cursor:pointer;margin-left:.5rem;display:flex;align-items:center;
  }
  .send-btn img{width:28px;height:28px;}

  @media(max-width:600px){
    body{padding:10px;height:calc(100vh - 20px);}
    .chat{width:100%;height:90vh;}
  }
</style>
</head>

<body>
  <div class="chat">
    <div id="msgs" class="msgs"></div>

    <form id="composer" class="composer">
      <textarea id="input" rows="1" placeholder="Type your message…"></textarea>
      <button type="submit" class="send-btn">
        <img src="https://assets.streamlinehq.com/image/private/w_300,h_300,ar_1/f_auto/v1/icons/4/send-ja31aidt5vl3o9cqzg4hl.png/send-tmq8104cb40rfwri9rga2.png?_a=DATAdtAAZAA0" alt="Send">
      </button>
    </form>
  </div>

<script>
  /* ---------- config ---------- */
  const WEBHOOK   = 'https://deepfeed.app.n8n.cloud/webhook/17893bdb-97ae-4ba9-9c97-7ec6f0e644bb';
  const sessionId = crypto.randomUUID(); // fresh session on each page load

  /* ---------- DOM hooks ---------- */
  const msgs  = document.getElementById('msgs');
  const input = document.getElementById('input');
  const form  = document.getElementById('composer');

  /* ---------- helpers ---------- */
  function add(text, role){
    const div = document.createElement('div');
    div.className = `bubble ${role}`;
    div.textContent = text;
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    return div;
  }

  function addTypingBubble(){
    const div = document.createElement('div');
    div.className = 'bubble bot';
    div.textContent = '…';
    msgs.appendChild(div);
    msgs.scrollTop = msgs.scrollHeight;
    return div;
  }

  /* ---------- textarea auto-grow ---------- */
  function autoGrow(){
    input.style.height = 'auto';
    input.style.height = input.scrollHeight + 'px';
  }
  input.addEventListener('input', autoGrow);
  autoGrow();

  /* ---------- send logic ---------- */
  form.addEventListener('submit', sendMessage);
  input.addEventListener('keydown', e=>{
    if(e.key==='Enter' && !e.shiftKey){
      e.preventDefault();
      sendMessage(e);
    }
  });

  async function sendMessage(e){
    if(e) e.preventDefault();
    const txt = input.value.trim();
    if(!txt) return;

    add(txt,'user');
    input.value = '';
    autoGrow();

    const loader = addTypingBubble();

    try{
      const res = await fetch(`${WEBHOOK}?action=sendMessage`,{
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify({ chatInput: txt, sessionId })
      });

      if(!res.ok) throw new Error(`HTTP ${res.status}`);

      const data = await res.json();

      loader.remove();

      const messages = Array.isArray(data.responses)
        ? data.responses
        : (data.output ? [data.output] : []);

      (messages.length ? messages : ['⚠️ No reply received'])
        .forEach(m => add(m,'bot'));

    }catch(err){
      console.error('fetch error →', err);
      loader.textContent = '⚠️ error';
    }
  }
</script>
</body>
</html>
