<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<title>ChatWidget</title>
<style>
  body {
    margin: 0;
    padding: 0;
    font: 16px/1.5 "Inter", sans-serif;
    background: #f9fafb;
    display: flex;
    justify-content: center;
    align-items: center;
    height: 100vh;
  }
  .chat {
    width: 620px;
    height: 520px;
    max-width: 95%;
    border: 1px solid #E9E9E9;
    border-radius: 30px;
    background: #ffffff;
    display: flex;
    flex-direction: column;
    overflow: hidden;
  }
  .msgs {
    flex: 1;
    overflow-y: auto;
    padding: 1rem;
  }
  .bubble {
    display: inline-block;
    padding: .6rem 1rem;
    border-radius: 18px;
    white-space: pre-line;
    margin-bottom: 1rem;
    max-width: 80%;
  }
  .user {
    background: #2563eb;
    color: #fff;
    border-bottom-right-radius: 0;
    align-self: flex-end;
  }
  .bot {
    background: #f3f4f6;
    color: #111827;
    border-bottom-left-radius: 0;
    align-self: flex-start;
  }
  .composer {
    padding: 1rem;
    border-top: 1px solid #e5e7eb;
    background: #fafafa;
    display: flex;
    flex-direction: column;
  }
  textarea {
    width: 100%;
    padding: .75rem;
    border: none;
    border-radius: 12px;
    resize: none;
    font-family: inherit;
    background: #f9fafb;
    outline: none;
    font-size: 16px;
  }
  button {
    display: none;
  }

  @media (max-width: 600px) {
    .chat {
      width: 90%;
      height: 90vh;
      border-radius: 20px;
    }
  }
</style>
</head>

<body>
<div class="chat">
  <div id="msgs" class="msgs"></div>

  <form id="composer" class="composer">
    <textarea id="input" rows="2" placeholder="Type your message…"></textarea>
    <button>Send</button>
  </form>
</div>

<script>
const webhook = 'https://deepfeed.app.n8n.cloud/webhook/17893bdb-97ae-4ba9-9c97-7ec6f0e644bb';
const sessionId = crypto.randomUUID();  // always fresh session on reload
const msgs = document.getElementById('msgs');
const input = document.getElementById('input');

document.getElementById('composer').addEventListener('submit', async e => {
  e.preventDefault();
  await sendMessage();
});

input.addEventListener('keydown', async e => {
  if (e.key === 'Enter' && !e.shiftKey) {
    e.preventDefault();
    await sendMessage();
  }
});

async function sendMessage() {
  const txt = input.value.trim();
  if (!txt) return;
  add(txt, 'user');
  input.value = '';

  const loader = addTypingBubble();

  try {
    const res = await fetch(`${webhook}?action=sendMessage`, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ chatInput: txt, sessionId })
    });
    const data = await res.json();
    console.log('n8n responded:', data);

    loader.remove();

    const messages = Array.isArray(data.responses)
      ? data.responses
      : (data.output ? [data.output] : []);

    if (messages.length > 0) {
      messages.forEach(r => add(r, 'bot'));
    } else {
      add('⚠️ No reply received', 'bot');
    }
  } catch (err) {
    console.error(err);
    loader.textContent = '⚠️ error';
  }
}

function add(text, role) {
  const div = document.createElement('div');
  div.className = `bubble ${role === 'user' ? 'user' : 'bot'}`;
  div.textContent = text;
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div;
}

function addTypingBubble() {
  const div = document.createElement('div');
  div.className = 'bubble bot';
  div.innerHTML = '<span class="dot"></span> <span class="dot"></span> <span class="dot"></span>';
  div.style.animation = 'blink 1s infinite';
  msgs.appendChild(div);
  msgs.scrollTop = msgs.scrollHeight;
  return div;
}
</script>
</body>
</html>
